# Prompt para Claude Code: Eliminar AWS Textract y Mejorar Dual Ensemble

## üéØ OBJETIVO

AWS Textract result√≥ ser **terrible** para nuestro caso de uso (c√©dulas manuscritas colombianas). Necesito:

1. **Eliminar completamente AWS Textract** del proyecto
2. **Verificar y mejorar el Dual Ensemble** (Google + Azure)
3. **Asegurar que la comparaci√≥n d√≠gito por d√≠gito funciona correctamente**
4. **Mejorar la l√≥gica de selecci√≥n por confianza individual**
5. **Agregar logging detallado** para ver exactamente qu√© est√° pasando

---

## üóëÔ∏è TAREA 1: Eliminar AWS Textract Completamente

### Archivos a eliminar:

1. **`src/infrastructure/ocr/aws_textract_adapter.py`**
   - Eliminar archivo completo

2. **`src/infrastructure/ocr/triple_ensemble_ocr.py`**
   - Eliminar archivo completo (ya no necesitamos 3-way voting)

3. **`tests/unit/test_aws_textract.py`** (si existe)
   - Eliminar archivo completo

4. **`docs/AWS_TEXTRACT_SETUP.md`** (si existe)
   - Eliminar archivo completo

### Archivos a actualizar:

1. **`src/infrastructure/ocr/__init__.py`**
   - Eliminar import de `AWSTextractAdapter`
   - Eliminar import de `TripleEnsembleOCR`
   - Eliminar opciones `'aws_textract'` y `'triple_ensemble'` del factory

2. **`requirements.txt`**
   - Eliminar l√≠nea: `boto3>=1.34.0` (si est√°)

3. **`config/settings.yaml`**
   - Eliminar secci√≥n completa de `aws_textract`
   - Cambiar `provider` de `triple_ensemble` a `dual_ensemble`
   - Eliminar cualquier referencia a AWS

4. **`.env` y `.env.example`**
   - Eliminar variables: `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_DEFAULT_REGION`

---

## ‚úÖ TAREA 2: Verificar y Mejorar Dual Ensemble

### Archivo: `src/infrastructure/ocr/digit_level_ensemble_ocr.py`

**Verificar que existe y funciona correctamente:**

### 2.1 Verificar que `get_character_confidences()` funciona

**En GoogleVisionAdapter:**
```python
def get_character_confidences(self, text: str) -> Dict[str, List[float]]:
    """
    CR√çTICO: Este m√©todo DEBE retornar confianzas individuales por car√°cter.
    
    Returns:
        {
            'confidences': [0.98, 0.95, 0.97, ...],  # Un valor por cada car√°cter
            'positions': [0, 1, 2, ...],
            'average': 0.963
        }
    """
    if not self.last_raw_response:
        raise ValueError("No hay respuesta de Google Vision disponible")
    
    # Verificar que este m√©todo realmente extrae confianzas del response
    # NO debe retornar valores fake o placeholder
```

**En AzureVisionAdapter:**
```python
def get_character_confidences(self, text: str) -> Dict[str, List[float]]:
    """
    CR√çTICO: Este m√©todo DEBE retornar confianzas individuales por palabra/car√°cter.
    
    Azure Read API da confianza por PALABRA, no por car√°cter.
    Necesitas mapear cada palabra a sus caracteres y asignar la confianza de la palabra
    a todos los caracteres de esa palabra.
    """
    if not self.last_raw_response:
        raise ValueError("No hay respuesta de Azure Vision disponible")
    
    # Implementar correctamente
```

### 2.2 Mejorar la l√≥gica de votaci√≥n por d√≠gito

**En `DigitLevelEnsembleOCR._vote_single_digit()`:**

```python
def _vote_single_digit(self, votes: List[DigitVote]) -> Optional[DigitConsensus]:
    """
    Vota por un solo d√≠gito usando confianza individual.
    
    L√≥gica MEJORADA:
    1. Si ambos coinciden (mismo d√≠gito):
       - Usar el d√≠gito con confianza promedio boosteada
       - Ejemplo: Google "5" (95%) + Azure "5" (93%) = "5" (97% boosted)
    
    2. Si difieren (diferentes d√≠gitos):
       - Usar el d√≠gito con MAYOR confianza individual
       - SOLO si la diferencia de confianza es > 10%
       - Si la diferencia es < 10%, RECHAZAR (ambiguo)
       
    3. Threshold m√≠nimo absoluto:
       - Cualquier d√≠gito con confianza < 75% se RECHAZA
       - Esto evita elegir d√≠gitos dudosos
    
    Returns:
        DigitConsensus o None si se rechaza
    """
    
    if len(votes) != 2:
        raise ValueError("Dual ensemble requiere exactamente 2 votos")
    
    google_vote = votes[0]  # Asumiendo orden: [google, azure]
    azure_vote = votes[1]
    
    # Threshold de confianza m√≠nima absoluta
    MIN_CONFIDENCE = 0.75
    
    # Verificar que ambos superen el m√≠nimo
    if google_vote.confidence < MIN_CONFIDENCE:
        self.logger.warning(
            f"Pos {google_vote.position}: Google '{google_vote.digit}' "
            f"tiene confianza muy baja ({google_vote.confidence:.2%})"
        )
        return None
    
    if azure_vote.confidence < MIN_CONFIDENCE:
        self.logger.warning(
            f"Pos {azure_vote.position}: Azure '{azure_vote.digit}' "
            f"tiene confianza muy baja ({azure_vote.confidence:.2%})"
        )
        return None
    
    # CASO 1: Coinciden (mismo d√≠gito)
    if google_vote.digit == azure_vote.digit:
        avg_conf = (google_vote.confidence + azure_vote.confidence) / 2
        boosted_conf = min(0.99, avg_conf + 0.03)  # Boost por coincidencia
        
        self.logger.debug(
            f"Pos {google_vote.position}: COINCIDENCIA '{google_vote.digit}' "
            f"Google={google_vote.confidence:.2%} "
            f"Azure={azure_vote.confidence:.2%} "
            f"‚Üí Final={boosted_conf:.2%}"
        )
        
        return DigitConsensus(
            final_digit=google_vote.digit,
            confidence=boosted_conf,
            votes=votes,
            consensus_type='unanimous',
            agreement_count=2
        )
    
    # CASO 2: NO coinciden (diferentes d√≠gitos)
    conf_diff = abs(google_vote.confidence - azure_vote.confidence)
    
    # Si la diferencia de confianza es muy peque√±a, es ambiguo
    if conf_diff < 0.10:  # Menos de 10% de diferencia
        self.logger.warning(
            f"Pos {google_vote.position}: CONFLICTO AMBIGUO "
            f"Google='{google_vote.digit}' ({google_vote.confidence:.2%}) "
            f"Azure='{azure_vote.digit}' ({azure_vote.confidence:.2%}) "
            f"Diferencia={conf_diff:.2%} < 10% ‚Üí RECHAZADO"
        )
        return None
    
    # Elegir el de mayor confianza
    if google_vote.confidence > azure_vote.confidence:
        winner = google_vote
        loser = azure_vote
        source = 'Google'
    else:
        winner = azure_vote
        loser = google_vote
        source = 'Azure'
    
    self.logger.warning(
        f"Pos {winner.position}: CONFLICTO RESUELTO "
        f"Google='{google_vote.digit}' ({google_vote.confidence:.2%}) "
        f"Azure='{azure_vote.digit}' ({azure_vote.confidence:.2%}) "
        f"‚Üí Elegido '{winner.digit}' de {source}"
    )
    
    return DigitConsensus(
        final_digit=winner.digit,
        confidence=winner.confidence,
        votes=votes,
        consensus_type='highest_confidence',
        agreement_count=1
    )
```

### 2.3 Mejorar logging detallado

**Agregar logging en cada paso cr√≠tico:**

```python
def _combine_by_digit(self, primary: Dict, secondary: Dict) -> Optional[Dict]:
    """
    Combina dos c√©dulas d√≠gito por d√≠gito con logging detallado.
    """
    self.logger.info(f"\n{'='*80}")
    self.logger.info(f"COMPARACI√ìN D√çGITO POR D√çGITO")
    self.logger.info(f"{'='*80}")
    self.logger.info(f"Google:  {primary['text']}")
    self.logger.info(f"Azure:   {secondary['text']}")
    self.logger.info(f"{'='*80}")
    
    # Tabla de comparaci√≥n
    self.logger.info(f"\n{'Pos':<5} {'Google':<15} {'Azure':<15} {'Elegido':<15} {'Tipo':<12}")
    self.logger.info(f"{'-'*5} {'-'*15} {'-'*15} {'-'*15} {'-'*12}")
    
    final_digits = []
    consensus_details = []
    
    for i in range(max_len):
        # ... l√≥gica de votaci√≥n ...
        
        consensus = self._vote_single_digit(votes)
        
        if not consensus:
            self.logger.error(f"{i:<5} RECHAZADO - No cumple criterios de confianza")
            return None
        
        # Log de cada d√≠gito
        google_str = f"'{votes[0].digit}' ({votes[0].confidence:.2%})"
        azure_str = f"'{votes[1].digit}' ({votes[1].confidence:.2%})"
        final_str = f"'{consensus.final_digit}' ({consensus.confidence:.2%})"
        
        self.logger.info(
            f"{i:<5} {google_str:<15} {azure_str:<15} {final_str:<15} {consensus.consensus_type:<12}"
        )
        
        final_digits.append(consensus.final_digit)
        consensus_details.append(consensus)
    
    self.logger.info(f"{'='*80}\n")
    
    # Estad√≠sticas finales
    unanimous = sum(1 for c in consensus_details if c.consensus_type == 'unanimous')
    conflicts = sum(1 for c in consensus_details if c.consensus_type == 'highest_confidence')
    
    self.logger.info(f"ESTAD√çSTICAS:")
    self.logger.info(f"  Coincidencias: {unanimous}/{len(consensus_details)} ({unanimous/len(consensus_details)*100:.1f}%)")
    self.logger.info(f"  Conflictos:    {conflicts}/{len(consensus_details)} ({conflicts/len(consensus_details)*100:.1f}%)")
    
    # Si hay muchos conflictos, es sospechoso
    if conflicts > len(consensus_details) * 0.3:  # M√°s del 30%
        self.logger.warning(
            f"‚ö† ADVERTENCIA: {conflicts} conflictos ({conflicts/len(consensus_details)*100:.1f}%) "
            f"es mucho. La c√©dula puede ser de baja calidad."
        )
    
    return {
        'cedula': ''.join(final_digits),
        'avg_confidence': sum(c.confidence for c in consensus_details) / len(consensus_details),
        'consensus_details': consensus_details,
        'stats': {
            'unanimous': unanimous,
            'conflicts': conflicts,
            'total': len(consensus_details)
        }
    }
```

---

## üîç TAREA 3: Agregar Tests de Verificaci√≥n

### Archivo: `tests/unit/test_digit_level_ensemble.py`

**Agregar tests espec√≠ficos para verificar la l√≥gica:**

```python
import pytest
from src.infrastructure.ocr.digit_level_ensemble_ocr import (
    DigitLevelEnsembleOCR,
    DigitVote,
    DigitConsensus
)

class TestDigitVoting:
    """Tests para verificar la l√≥gica de votaci√≥n por d√≠gito."""
    
    def test_unanimous_vote_boosts_confidence(self):
        """Cuando ambos coinciden, la confianza debe aumentar."""
        ensemble = DigitLevelEnsembleOCR(...)
        
        votes = [
            DigitVote(digit='5', confidence=0.90, source='google', position=0),
            DigitVote(digit='5', confidence=0.92, source='azure', position=0)
        ]
        
        result = ensemble._vote_single_digit(votes)
        
        assert result is not None
        assert result.final_digit == '5'
        assert result.consensus_type == 'unanimous'
        assert result.confidence > 0.91  # Boosted
    
    def test_conflict_with_clear_winner(self):
        """Cuando difieren pero hay clara diferencia de confianza."""
        ensemble = DigitLevelEnsembleOCR(...)
        
        votes = [
            DigitVote(digit='1', confidence=0.95, source='google', position=0),
            DigitVote(digit='7', confidence=0.78, source='azure', position=0)
        ]
        
        result = ensemble._vote_single_digit(votes)
        
        assert result is not None
        assert result.final_digit == '1'  # Google gan√≥
        assert result.consensus_type == 'highest_confidence'
    
    def test_conflict_ambiguous_rejects(self):
        """Cuando difieren y la diferencia es peque√±a, debe rechazar."""
        ensemble = DigitLevelEnsembleOCR(...)
        
        votes = [
            DigitVote(digit='3', confidence=0.86, source='google', position=0),
            DigitVote(digit='8', confidence=0.84, source='azure', position=0)
        ]
        
        result = ensemble._vote_single_digit(votes)
        
        assert result is None  # Rechazado por ser ambiguo
    
    def test_low_confidence_rejects(self):
        """Cuando ambos tienen confianza baja, debe rechazar."""
        ensemble = DigitLevelEnsembleOCR(...)
        
        votes = [
            DigitVote(digit='5', confidence=0.68, source='google', position=0),
            DigitVote(digit='5', confidence=0.72, source='azure', position=0)
        ]
        
        result = ensemble._vote_single_digit(votes)
        
        assert result is None  # Rechazado por confianza < 75%
    
    def test_full_cedula_processing(self):
        """Test de integraci√≥n con c√©dula completa."""
        # Mock de Google y Azure adapters
        google = Mock()
        azure = Mock()
        
        # Simular respuestas
        google.extract_numbers.return_value = ["1036221525"]
        google.get_character_confidences.return_value = {
            'confidences': [0.98, 0.95, 0.97, 0.94, 0.92, 0.93, 0.96, 0.91, 0.94, 0.95],
            'positions': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
            'average': 0.945
        }
        
        azure.extract_numbers.return_value = ["1036221525"]
        azure.get_character_confidences.return_value = {
            'confidences': [0.96, 0.97, 0.96, 0.95, 0.94, 0.92, 0.93, 0.94, 0.93, 0.96],
            'positions': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
            'average': 0.946
        }
        
        ensemble = DigitLevelEnsembleOCR(config, google, azure)
        image = Mock()
        
        result = ensemble.extract_numbers(image)
        
        assert len(result) == 1
        assert result[0] == "1036221525"
```

---

## üìä TAREA 4: Agregar Script de Diagn√≥stico

### Archivo: `scripts/test_ensemble_confidence.py`

**Script para probar con imagen real y ver logs detallados:**

```python
"""
Script de diagn√≥stico para verificar el ensemble con imagen real.
"""

import sys
from pathlib import Path
from PIL import Image

# Agregar src al path
sys.path.insert(0, str(Path(__file__).parent.parent))

from src.infrastructure.ocr import create_ocr_adapter
from src.infrastructure.config import YAMLConfig

def main():
    # Cargar config
    config = YAMLConfig('config/settings.yaml')
    
    # Crear OCR (debe ser dual_ensemble)
    ocr = create_ocr_adapter(config)
    
    print(f"OCR Type: {type(ocr).__name__}")
    print(f"Expected: DigitLevelEnsembleOCR\n")
    
    # Cargar imagen de prueba
    test_image_path = input("Ingresa la ruta de la imagen de prueba: ")
    
    try:
        image = Image.open(test_image_path)
        print(f"‚úì Imagen cargada: {test_image_path}")
        print(f"  Tama√±o: {image.size}")
        print(f"  Modo: {image.mode}\n")
    except Exception as e:
        print(f"‚úó Error cargando imagen: {e}")
        return
    
    # Extraer c√©dulas con logging detallado
    print("="*80)
    print("INICIANDO EXTRACCI√ìN CON DUAL ENSEMBLE")
    print("="*80)
    
    try:
        cedulas = ocr.extract_numbers(image)
        
        print("\n" + "="*80)
        print("RESULTADOS FINALES")
        print("="*80)
        
        if cedulas:
            print(f"‚úì {len(cedulas)} c√©dula(s) extra√≠da(s):")
            for i, cedula in enumerate(cedulas, 1):
                print(f"  {i}. {cedula}")
        else:
            print("‚úó No se extrajo ninguna c√©dula")
            print("  Posibles razones:")
            print("  - Confianzas muy bajas (< 75%)")
            print("  - Muchos conflictos ambiguos")
            print("  - Imagen de mala calidad")
        
    except Exception as e:
        print(f"\n‚úó ERROR: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()
```

---

## üéØ TAREA 5: Actualizar Configuraci√≥n

### Archivo: `config/settings.yaml`

**Asegurar que la configuraci√≥n sea correcta:**

```yaml
# OCR Configuration
ocr:
  provider: dual_ensemble  # ‚Üê VERIFICAR QUE SEA dual_ensemble
  
  # Dual Ensemble (Google + Azure)
  ensemble:
    min_digit_confidence: 0.75      # Confianza m√≠nima por d√≠gito (75%)
    min_agreement_ratio: 0.60       # Ratio m√≠nimo de similitud para emparejar (60%)
    confidence_boost: 0.03          # Boost cuando coinciden (3%)
    max_conflict_ratio: 0.30        # M√°ximo de conflictos aceptable (30%)
    ambiguity_threshold: 0.10       # Diferencia m√≠nima para resolver conflicto (10%)
    verbose_logging: true           # Logging detallado
  
  # Google Cloud Vision API
  google_vision:
    authentication: application_default
    project_id: firmas-automatizacion
    confidence_threshold: 0.85
  
  # Azure Computer Vision Read API v4.0
  azure_vision:
    endpoint: "${AZURE_VISION_ENDPOINT}"
    subscription_key: "${AZURE_VISION_KEY}"
    api_version: "2024-02-01"
    confidence_threshold: 0.85
    max_retries: 3
    timeout: 30

# NO debe haber ninguna secci√≥n aws_textract aqu√≠

# Image Preprocessing (mantener igual)
image_preprocessing:
  enabled: true
  upscale_factor: 3
  denoise:
    enabled: true
    h: 10
  # ... resto de configuraci√≥n
```

---

## ‚úÖ TAREA 6: Verificaci√≥n Final

### Checklist de verificaci√≥n:

**Archivos eliminados:**
- [ ] `src/infrastructure/ocr/aws_textract_adapter.py` eliminado
- [ ] `src/infrastructure/ocr/triple_ensemble_ocr.py` eliminado
- [ ] `tests/unit/test_aws_textract.py` eliminado (si exist√≠a)
- [ ] `docs/AWS_TEXTRACT_SETUP.md` eliminado (si exist√≠a)
- [ ] `boto3` eliminado de `requirements.txt`
- [ ] Variables AWS eliminadas de `.env` y `.env.example`

**C√≥digo verificado:**
- [ ] `GoogleVisionAdapter.get_character_confidences()` retorna confianzas REALES
- [ ] `AzureVisionAdapter.get_character_confidences()` retorna confianzas REALES
- [ ] `DigitLevelEnsembleOCR._vote_single_digit()` implementa l√≥gica correcta:
  - [ ] Threshold m√≠nimo de 75%
  - [ ] Boost por coincidencia (+3%)
  - [ ] Rechazo si diferencia < 10%
  - [ ] Logging detallado en cada decisi√≥n

**Tests:**
- [ ] Tests de votaci√≥n pasan
- [ ] Test con imagen real funciona
- [ ] Script de diagn√≥stico ejecuta sin errores

**Configuraci√≥n:**
- [ ] `config/settings.yaml` tiene `provider: dual_ensemble`
- [ ] No hay referencias a AWS en ning√∫n lugar
- [ ] Par√°metros de ensemble configurados correctamente

---

## üîç TAREA 7: Ejemplo de Output Esperado

Cuando ejecutes el script de diagn√≥stico, deber√≠as ver algo como:

```
================================================================================
INICIANDO DUAL ENSEMBLE OCR CON CONFIANZA POR D√çGITO
================================================================================

‚úì Google Vision encontr√≥: 1 c√©dula(s)
‚úì Azure Vision encontr√≥: 1 c√©dula(s)
‚úì Emparejadas: 1 grupo(s)

================================================================================
COMPARACI√ìN D√çGITO POR D√çGITO
================================================================================
Google:  1036221525
Azure:   1036221525
================================================================================

Pos   Google          Azure           Elegido         Tipo        
----- --------------- --------------- --------------- ------------
0     '1' (98%)       '1' (96%)       '1' (99%)       unanimous   
1     '0' (95%)       '0' (97%)       '0' (98%)       unanimous   
2     '3' (92%)       '3' (96%)       '3' (97%)       unanimous   
3     '6' (94%)       '6' (95%)       '6' (97%)       unanimous   
4     '2' (89%)       '2' (94%)       '2' (95%)       unanimous   
5     '2' (93%)       '2' (91%)       '2' (95%)       unanimous   
6     '1' (96%)       '1' (93%)       '1' (97%)       unanimous   
7     '5' (90%)       '5' (93%)       '5' (94%)       unanimous   
8     '2' (88%)       '2' (92%)       '2' (92%)       unanimous   
9     '5' (95%)       '5' (94%)       '5' (97%)       unanimous   
================================================================================

ESTAD√çSTICAS:
  Coincidencias: 10/10 (100.0%)
  Conflictos:    0/10 (0.0%)

‚Üí RESULTADO: 1036221525 (confianza: 96.1%)

================================================================================
RESULTADO FINAL: 1 c√©dula(s) extra√≠da(s)
================================================================================
```

**En caso de conflicto:**

```
Pos   Google          Azure           Elegido         Tipo        
----- --------------- --------------- --------------- ------------
0     '1' (98%)       '7' (82%)       '1' (98%)       highest_confidence ‚ö†
      ‚ö† CONFLICTO: Google vs Azure, diferencia 16% ‚Üí Elegido '1' de Google
```

**En caso de rechazo:**

```
Pos   Google          Azure           Elegido         Tipo        
----- --------------- --------------- --------------- ------------
0     '3' (86%)       '8' (84%)       RECHAZADO      ambiguous
      ‚úó RECHAZADO: Diferencia (2%) < 10% ‚Üí Demasiado ambiguo
```

---

## üìù RESUMEN

**Claude Code, por favor:**

1. ‚úÖ Elimina completamente AWS Textract y triple ensemble
2. ‚úÖ Verifica que `get_character_confidences()` funciona en Google y Azure
3. ‚úÖ Mejora la l√≥gica de votaci√≥n con thresholds claros
4. ‚úÖ Agrega logging detallado en cada decisi√≥n
5. ‚úÖ Crea tests para verificar la l√≥gica
6. ‚úÖ Crea script de diagn√≥stico para pruebas manuales
7. ‚úÖ Actualiza configuraci√≥n para usar solo dual_ensemble

**Objetivo final:** Tener un dual ensemble robusto que tome las mejores decisiones d√≠gito por d√≠gito con logging claro para entender qu√© est√° pasando.

---

**¬øListo para limpiar el c√≥digo y mejorar el ensemble?** üöÄ